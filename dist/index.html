
<html>
<head>
  <title>PSPDFKit Sync Scrolling</title>
</head>
<style>
  #viewer-container {
    display: flex;
    height: 100vh;
  }

  #viewer-container > div {
    width: 50%;
    height: 100%;
  }
</style>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>

  <script src="./assets/pspdfkit.js"></script>
  <div id="viewer-container">
    <div id="pspdfkitLeft"></div>
    <div id="pspdfkitRight"></div>
  </div>


  <script>

    let leftViewer, rightViewer;

    // Include fast-diff library

    async function compareText(instance1, instance2) {
      const pageCount = await instance1.totalPageCount;
  
      for (let pageIndex = 0; pageIndex < pageCount; pageIndex++) {
          const [textLines1, textLines2] = await Promise.all([
              instance1.textLinesForPageIndex(pageIndex),
              instance2.textLinesForPageIndex(pageIndex),
          ]);
  
          const lineContents1 = textLines1.toArray().map(line => line.contents).join('\n');
          const lineContents2 = textLines2.toArray().map(line => line.contents).join('\n');
  
          // Execute diff algorithm on the strings
          const diffs = Diff.diffChars(lineContents1, lineContents2);
  
          let index1 = 0, index2 = 0;
  
          diffs.forEach(part => {
              const lines = part.value.split('\n');
              lines.pop(); // Remove the last element which is an empty string resulted from splitting
  
              lines.forEach((line, i) => {
                if (part.added || part.removed) {
                  const words = Diff.diffWords(lineContents1, lineContents2);
                  words.forEach((word) => {
                      if (word.added) {
                        console.log(`Insertion: "${word.value}"`);
                        console.log(textLines2.get(index2).boundingBox);
                          //const quads = textLines2.get(index2).quads;
                          const boundingBox = textLines2.get(index2).boundingBox
              
                         
                          const highlightAnnotationRight = new PSPDFKit.Annotations.HighlightAnnotation({
                              note: `Insertion: "${word.value}"`,
                              boundingBox: boundingBox,
                              pageIndex: pageIndex,
                              rects: PSPDFKit.Immutable.List.of(boundingBox),
                              color: PSPDFKit.Color.GREEN,
                              opacity: 0.5,
                          });
              
                          instance2.create(highlightAnnotationRight);
                          index2++;
                      }
                      if (word.removed) {
                        console.log(`Deletion: "${word.value}"`);
                          //const quads = textLines1.get(index1).quads;
                          const boundingBox = textLines1.get(index1).boundingBox
              
                          const highlightAnnotationLeft = new PSPDFKit.Annotations.HighlightAnnotation({
                              note: `Deletion: "${word.value}"`,
                              boundingBox: boundingBox,
                              pageIndex: pageIndex,
                              rects: PSPDFKit.Immutable.List.of(boundingBox),
                              color: PSPDFKit.Color.RED,
                              opacity: 0.5,
                          });
              
                          instance1.create(highlightAnnotationLeft);
                          index1++;
                      }
                  });
              }
              
              });
          });
      }
  }
  
    
    
    function getDifference(str1, str2) {
      let i = 0;
      while(i < str1.length && i < str2.length && str1[i] === str2[i]) {
        i++;
      }
    
      return str1.substring(i);
    }
    


    PSPDFKit.load({
      container: "#pspdfkitLeft",
      document: "PDF poem v1.pdf",

    })
    .then(async function(instance) {
      console.log("PSPDFKit Left loaded", instance);
      leftViewer = instance;

      // Add event listeners for the left viewer to sync its state to the right viewer
      let scrollElement = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.addEventListener("scroll", syncViewStateLeft);

      // TODO: Needed when viewer is in single page mode
      //instance.addEventListener("viewState.currentPageIndex.change", syncViewState);
      instance.addEventListener("viewState.zoom.change", syncViewStateLeft);

      window.setTimeout(() => {
        if (leftViewer && rightViewer) {
          compareText(leftViewer, rightViewer);
        }
      }, 500);

    })
    .catch(function(error) {
      console.error(error.message);
    });

    PSPDFKit.load({
      container: "#pspdfkitRight",
      document: "PDF poem v3.pdf",

    })
    .then(async function(instance) {
      console.log("PSPDFKit Right loaded", instance);
      rightViewer = instance;

      let scrollElement = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.addEventListener("scroll", syncViewStateRight);

      // TODO: Needed when viewer is in single page mode
      //instance.addEventListener("viewState.currentPageIndex.change", syncViewState2);
      instance.addEventListener("viewState.zoom.change", syncViewStateRight);

    })
    .catch(function(error) {
      console.error(error.message);
    });

    function syncViewStateLeft() {

      let scrollElementR = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElementR.removeEventListener("scroll", syncViewStateRight);

      // This is the data that needs to be send over to the other
      // viewer, e.g. via WebSockets.
      
      // Get the current view state from the left viewer
      let customViewState = {
        pageNumber: leftViewer.viewState.currentPageIndex,
        zoomLevel: leftViewer.viewState.zoom,
        scrollLeft: leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollLeft,
        scrollTop: leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollTop,
      };
    
      // Set the page number
      let viewState = rightViewer.viewState;
      rightViewer.setViewState(viewState.set("currentPageIndex", customViewState.pageNumber));
    
      // Set the zoom level
      rightViewer.setViewState(viewState.set("zoom", customViewState.zoomLevel));
    
      // Set scroll position
      let scrollElement = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.scrollLeft = customViewState.scrollLeft;
      scrollElement.scrollTop = customViewState.scrollTop;

      window.setTimeout(() => {
        scrollElementR.addEventListener("scroll", syncViewStateRight);
      }, 0);
    }

    function syncViewStateRight() {

      let scrollElementL = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElementL.removeEventListener("scroll", syncViewStateLeft);

      // This is the data that needs to be send over to the other
      // viewer, e.g. via WebSockets.
      
      // Get the current view state from the left viewer
      let customViewState = {
        pageNumber: rightViewer.viewState.currentPageIndex,
        zoomLevel: rightViewer.viewState.zoom,
        scrollLeft: rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollLeft,
        scrollTop: rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollTop,
      };
    
      // Set the page number
      let viewState = leftViewer.viewState;
      leftViewer.setViewState(viewState.set("currentPageIndex", customViewState.pageNumber));
    
      // Set the zoom level
      leftViewer.setViewState(viewState.set("zoom", customViewState.zoomLevel));
    
      // Set scroll position
      let scrollElement = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.scrollLeft = customViewState.scrollLeft;
      scrollElement.scrollTop = customViewState.scrollTop;

      window.setTimeout(() => {
        scrollElementL.addEventListener("scroll", syncViewStateLeft);
      }, 0);
      
    }
  </script>

 

</body>
</html>
