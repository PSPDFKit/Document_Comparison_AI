
<html>
<head>
  <title>PSPDFKit Sync Scrolling</title>
</head>
<style>
  #viewer-container {
    display: flex;
    height: 100vh;
  }

  #viewer-container > div {
    width: 50%;
    height: 100%;
  }
</style>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>

  <script src="./assets/pspdfkit.js"></script>
  <div id="viewer-container">
    <div id="pspdfkitLeft"></div>
    <div id="pspdfkitRight"></div>
  </div>


  <script>

    let leftViewer, rightViewer;

    async function compareText(instance1, instance2, pageIndex) {
      const [textLines1, textLines2] = await Promise.all([
        instance1.textLinesForPageIndex(pageIndex),
        instance2.textLinesForPageIndex(pageIndex),
      ]);
    
      let index1 = 0, index2 = 0;
    
      while(index1 < textLines1.size && index2 < textLines2.size) {
        const line1 = textLines1.get(index1);
        const line2 = textLines2.get(index2);
    
        // First, check if the lines are exactly the same
        if(line1.contents === line2.contents) {
          index1++;
          index2++;
          continue;
        }
    
        // If they're not the same, check if the line exists somewhere else in the other document
        const line1InText2 = textLines2.find(line => line.contents === line1.contents);
        const line2InText1 = textLines1.find(line => line.contents === line2.contents);
    
        // If line1 exists in text2 but line2 does not exist in text1, line2 is an added line
        if(line1InText2 && !line2InText1) {
          const highlightAnnotation = new PSPDFKit.Annotations.HighlightAnnotation({
            note: `Line added: "${line2.contents}"`,
            boundingBox: line2.boundingBox,
            pageIndex,
            color: PSPDFKit.Color.GREEN,
            opacity: 0.5,
            rects: PSPDFKit.Immutable.List.of(line2.boundingBox),
          });
    
          instance2.create(highlightAnnotation);
    
          index2++;
          continue;
        }
    
        // If line2 exists in text1 but line1 does not exist in text2, line1 is a removed line
        if(line2InText1 && !line1InText2) {
          const highlightAnnotation = new PSPDFKit.Annotations.HighlightAnnotation({
            note: `Line removed: "${line1.contents}"`,
            boundingBox: line1.boundingBox,
            pageIndex,
            color: PSPDFKit.Color.RED,
            opacity: 0.5,
            rects: PSPDFKit.Immutable.List.of(line1.boundingBox),
          });
    
          instance1.create(highlightAnnotation);
    
          index1++;
          continue;
        }
    
        // If both lines exist in the other document, they have been moved
        if(line1InText2 && line2InText1) {
          index1++;
          index2++;
          continue;
        }
    
        // If none of the conditions above are met, the lines are different versions of each other
        const wordDiffs = Diff.diffWords(line1.contents, line2.contents);
        wordDiffs.forEach(wordDiff => {
          if (wordDiff.added || wordDiff.removed) {
            const note = wordDiff.added ? `Added: "${wordDiff.value}"` : `Deleted: "${wordDiff.value}"`;
    
            const highlightAnnotation = new PSPDFKit.Annotations.HighlightAnnotation({
              note,
              boundingBox: line2.boundingBox,
              pageIndex,
              color: wordDiff.added ? PSPDFKit.Color.GREEN : PSPDFKit.Color.RED,
              opacity: 0.5,
              rects: PSPDFKit.Immutable.List.of(line2.boundingBox),
            });
    
            (wordDiff.added ? instance2 : instance1).create(highlightAnnotation);
          }
        });
    
        index1++;
        index2++;
      }
    
      // After the while loop, if there are lines remaining in either document, they are all added/removed lines
      while(index1 < textLines1.size) {
        const line1 = textLines1.get(index1);
    
        const highlightAnnotation = new PSPDFKit.Annotations.HighlightAnnotation({
          note: `Line removed: "${line1.contents}"`,
          boundingBox: line1.boundingBox,
          pageIndex,
          color: PSPDFKit.Color.RED,
          opacity: 0.5,
          rects: PSPDFKit.Immutable.List.of(line1.boundingBox),
        });
    
        instance1.create(highlightAnnotation);
    
        index1++;
      }
    
      while(index2 < textLines2.size) {
        const line2 = textLines2.get(index2);
    
        const highlightAnnotation = new PSPDFKit.Annotations.HighlightAnnotation({
          note: `Line added: "${line2.contents}"`,
          boundingBox: line2.boundingBox,
          pageIndex,
          color: PSPDFKit.Color.GREEN,
          opacity: 0.5,
          rects: PSPDFKit.Immutable.List.of(line2.boundingBox),
        });
    
        instance2.create(highlightAnnotation);
    
        index2++;
      }
    }
    

    function getDifference(str1, str2) {
      let i = 0;
      while(i < str1.length && i < str2.length && str1[i] === str2[i]) {
        i++;
      }
    
      return str1.substring(i);
    }
    


    PSPDFKit.load({
      container: "#pspdfkitLeft",
      document: "PDF poem v1.pdf",

    })
    .then(async function(instance) {
      console.log("PSPDFKit Left loaded", instance);
      leftViewer = instance;

      // Add event listeners for the left viewer to sync its state to the right viewer
      let scrollElement = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.addEventListener("scroll", syncViewStateLeft);

      // TODO: Needed when viewer is in single page mode
      //instance.addEventListener("viewState.currentPageIndex.change", syncViewState);
      instance.addEventListener("viewState.zoom.change", syncViewStateLeft);

      window.setTimeout(() => {
        if (leftViewer && rightViewer) {
          compareText(leftViewer, rightViewer, 0);
        }
      }, 500);

    })
    .catch(function(error) {
      console.error(error.message);
    });

    PSPDFKit.load({
      container: "#pspdfkitRight",
      document: "PDF poem v3.pdf",

    })
    .then(async function(instance) {
      console.log("PSPDFKit Right loaded", instance);
      rightViewer = instance;

      let scrollElement = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.addEventListener("scroll", syncViewStateRight);

      // TODO: Needed when viewer is in single page mode
      //instance.addEventListener("viewState.currentPageIndex.change", syncViewState2);
      instance.addEventListener("viewState.zoom.change", syncViewStateRight);

    })
    .catch(function(error) {
      console.error(error.message);
    });

    function syncViewStateLeft() {

      let scrollElementR = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElementR.removeEventListener("scroll", syncViewStateRight);

      // This is the data that needs to be send over to the other
      // viewer, e.g. via WebSockets.
      
      // Get the current view state from the left viewer
      let customViewState = {
        pageNumber: leftViewer.viewState.currentPageIndex,
        zoomLevel: leftViewer.viewState.zoom,
        scrollLeft: leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollLeft,
        scrollTop: leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollTop,
      };
    
      // Set the page number
      let viewState = rightViewer.viewState;
      rightViewer.setViewState(viewState.set("currentPageIndex", customViewState.pageNumber));
    
      // Set the zoom level
      rightViewer.setViewState(viewState.set("zoom", customViewState.zoomLevel));
    
      // Set scroll position
      let scrollElement = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.scrollLeft = customViewState.scrollLeft;
      scrollElement.scrollTop = customViewState.scrollTop;

      window.setTimeout(() => {
        scrollElementR.addEventListener("scroll", syncViewStateRight);
      }, 0);
    }

    function syncViewStateRight() {

      let scrollElementL = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElementL.removeEventListener("scroll", syncViewStateLeft);

      // This is the data that needs to be send over to the other
      // viewer, e.g. via WebSockets.
      
      // Get the current view state from the left viewer
      let customViewState = {
        pageNumber: rightViewer.viewState.currentPageIndex,
        zoomLevel: rightViewer.viewState.zoom,
        scrollLeft: rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollLeft,
        scrollTop: rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollTop,
      };
    
      // Set the page number
      let viewState = leftViewer.viewState;
      leftViewer.setViewState(viewState.set("currentPageIndex", customViewState.pageNumber));
    
      // Set the zoom level
      leftViewer.setViewState(viewState.set("zoom", customViewState.zoomLevel));
    
      // Set scroll position
      let scrollElement = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.scrollLeft = customViewState.scrollLeft;
      scrollElement.scrollTop = customViewState.scrollTop;

      window.setTimeout(() => {
        scrollElementL.addEventListener("scroll", syncViewStateLeft);
      }, 0);
      
    }
  </script>

 

</body>
</html>
