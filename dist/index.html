
<html>
<head>
  <title>PSPDFKit Sync Scrolling</title>
</head>
<style>
  #viewer-container {
    display: flex;
    height: 100vh;
  }

  #viewer-container > div {
    width: 50%;
    height: 100%;
  }
</style>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>

  <script src="./assets/pspdfkit.js"></script>
  <div id="viewer-container">
    <div id="pspdfkitLeft"></div>
    <div id="pspdfkitRight"></div>
  </div>


  <script>

    let leftViewer, rightViewer;

    async function compareText(instance1, instance2) {
      const pageCount = await instance1.totalPageCount;
  
      for (let pageIndex = 0; pageIndex < pageCount; pageIndex++) {
          const [textLines1, textLines2] = await Promise.all([
              instance1.textLinesForPageIndex(pageIndex),
              instance2.textLinesForPageIndex(pageIndex),
          ]);
  
          const minLineCount = Math.min(textLines1.size, textLines2.size);
          for (let i = 0; i < minLineCount; i++) {
              const line1 = textLines1.get(i).contents;
              const line2 = textLines2.get(i).contents;
              const lineDiffs = Diff.diffWords(line1, line2);
  
              let addedWords = [], removedWords = [];
              lineDiffs.forEach(part => {
                  if (part.added) addedWords.push(part.value);
                  if (part.removed) removedWords.push(part.value);
              });
  
              if (addedWords.length > 0) {
                  const boundingBox = textLines2.get(i).boundingBox;
                  const highlightAnnotation = new PSPDFKit.Annotations.HighlightAnnotation({
                      note: `Insertion: "${addedWords.join(' ')}"`,
                      boundingBox: boundingBox,
                      pageIndex: pageIndex,
                      rects: PSPDFKit.Immutable.List.of(boundingBox),
                      color: PSPDFKit.Color.GREEN,
                      opacity: 0.5,
                  });
  
                  instance2.create(highlightAnnotation);
              }
  
              if (removedWords.length > 0) {
                  const boundingBox = textLines1.get(i).boundingBox;
                  const highlightAnnotation = new PSPDFKit.Annotations.HighlightAnnotation({
                      note: `Deletion: "${removedWords.join(' ')}"`,
                      boundingBox: boundingBox,
                      pageIndex: pageIndex,
                      rects: PSPDFKit.Immutable.List.of(boundingBox),
                      color: PSPDFKit.Color.RED,
                      opacity: 0.5,
                  });
  
                  instance1.create(highlightAnnotation);
              }
          }
      }
  }
  
    function getDifference(str1, str2) {
      let i = 0;
      while(i < str1.length && i < str2.length && str1[i] === str2[i]) {
        i++;
      }
    
      return str1.substring(i);
    }
    


    PSPDFKit.load({
      container: "#pspdfkitLeft",
      document: "PDF poem v1.pdf",

    })
    .then(async function(instance) {
      console.log("PSPDFKit Left loaded", instance);
      leftViewer = instance;

      // Add event listeners for the left viewer to sync its state to the right viewer
      let scrollElement = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.addEventListener("scroll", syncViewStateLeft);

      // TODO: Needed when viewer is in single page mode
      //instance.addEventListener("viewState.currentPageIndex.change", syncViewState);
      instance.addEventListener("viewState.zoom.change", syncViewStateLeft);

      window.setTimeout(() => {
        if (leftViewer && rightViewer) {
          compareText(leftViewer, rightViewer);
        }
      }, 500);

    })
    .catch(function(error) {
      console.error(error.message);
    });

    PSPDFKit.load({
      container: "#pspdfkitRight",
      document: "PDF poem v3.pdf",

    })
    .then(async function(instance) {
      console.log("PSPDFKit Right loaded", instance);
      rightViewer = instance;

      let scrollElement = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.addEventListener("scroll", syncViewStateRight);

      // TODO: Needed when viewer is in single page mode
      //instance.addEventListener("viewState.currentPageIndex.change", syncViewState2);
      instance.addEventListener("viewState.zoom.change", syncViewStateRight);

    })
    .catch(function(error) {
      console.error(error.message);
    });

    function syncViewStateLeft() {

      let scrollElementR = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElementR.removeEventListener("scroll", syncViewStateRight);

      // This is the data that needs to be send over to the other
      // viewer, e.g. via WebSockets.
      
      // Get the current view state from the left viewer
      let customViewState = {
        pageNumber: leftViewer.viewState.currentPageIndex,
        zoomLevel: leftViewer.viewState.zoom,
        scrollLeft: leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollLeft,
        scrollTop: leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollTop,
      };
    
      // Set the page number
      let viewState = rightViewer.viewState;
      rightViewer.setViewState(viewState.set("currentPageIndex", customViewState.pageNumber));
    
      // Set the zoom level
      rightViewer.setViewState(viewState.set("zoom", customViewState.zoomLevel));
    
      // Set scroll position
      let scrollElement = rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.scrollLeft = customViewState.scrollLeft;
      scrollElement.scrollTop = customViewState.scrollTop;

      window.setTimeout(() => {
        scrollElementR.addEventListener("scroll", syncViewStateRight);
      }, 0);
    }

    function syncViewStateRight() {

      let scrollElementL = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElementL.removeEventListener("scroll", syncViewStateLeft);

      // This is the data that needs to be send over to the other
      // viewer, e.g. via WebSockets.
      
      // Get the current view state from the left viewer
      let customViewState = {
        pageNumber: rightViewer.viewState.currentPageIndex,
        zoomLevel: rightViewer.viewState.zoom,
        scrollLeft: rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollLeft,
        scrollTop: rightViewer.contentDocument.querySelector(".PSPDFKit-Scroll").scrollTop,
      };
    
      // Set the page number
      let viewState = leftViewer.viewState;
      leftViewer.setViewState(viewState.set("currentPageIndex", customViewState.pageNumber));
    
      // Set the zoom level
      leftViewer.setViewState(viewState.set("zoom", customViewState.zoomLevel));
    
      // Set scroll position
      let scrollElement = leftViewer.contentDocument.querySelector(".PSPDFKit-Scroll");
      scrollElement.scrollLeft = customViewState.scrollLeft;
      scrollElement.scrollTop = customViewState.scrollTop;

      window.setTimeout(() => {
        scrollElementL.addEventListener("scroll", syncViewStateLeft);
      }, 0);
      
    }
  </script>

 

</body>
</html>
